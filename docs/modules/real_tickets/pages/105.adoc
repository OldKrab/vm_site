:lang: ru-RU
:source-highlighter: rouge
= 1.5 Записи активации. Секции стека вызовов.


==  Записи активации
Более широкий класс, чем секция стека. Не обязаны хранится на стеке

Может быть фиксированной длины (аппетит) или переменной (alloc? динамическое выделение памяти, стек операндов (кего размер меняется))

У разных функций могут быть разного формата в рамках одной ВМ.

*Секции фиксированного размера*

image::105/stack_frame_fixed.png[]

Секция активации кладет на стек параметры вызова, при вызове на стек кладется адрес возврата. Затем попадаем в #пролог# функции, который перемещает нас на секцию:

```cpp 
//prologue
//увеличиваем размер стека (растет к 0)
SP -= LocalSize(foo);
```

При выходе из функции мы отнимает от стека аппетит функции, удаляя рамку. 

```cpp 
//epilogue
SP += LocalSize(foo);
```

* Адресация параметров и локальных переменных `reg = [SP+offset];`

*Секции стека переменного размера*

image::105/stack_frame_dynamic.png[]

Особенность -- дополнительно храним FP -- регистр начала текущей секции стека (frame pointer, у intel -- bp -- base pointer)

Секция активации кладет в стек параметры вызова, вызывает функцию. Переходим в пролог, который сохраняет предыдущий FP (он оказывается за адресом возврата):

```cpp
//prologue
push(FP);
//запоминаем адрес текущего стека как fp
FP = SP;
//увеличиваем размер стека на начальный размер секции активации
SP -= LocalSize(foo);
```
При выходе восстанавливаем все FP

```cpp
//epilogue
SP = FP;
FP = pop();
```

Получаем #динамичекскую цепочку# -- односвязный список секций стека. 

Бывает #статическая цепочка# -- нужна для языков с блочной вложенностью (вложенные функции, из одной функции получаем доступ к переменным в другой функции).

* Адресация параметров

`reg = [FP+offset];`

* Адресация локальных переменных

`reg = [FP-offset];`
* Отведение локальной памяти

`alloca(size);`

*Примеры: стек вызова и запись активации*

[cols="1,2,2"]
|===
|VM
|Стек вызова
|Запись активации

|Smalltalk 
|нет (вызовы не LIFO)
|Объекты в куче 

|Forth 
|все операнды 
|только адрес возврата, поэтому хранят в стеке 

|Java
|свой у каждого потока
|создается при каждом вызове, сбрасывается при возврате. Содержит аргументы, место локальных переменных, место для стека операндов, служебные данные
|===
