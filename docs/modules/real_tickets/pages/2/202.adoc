= 2.2. Варианты динамической компиляции. Динамическая адаптивная компиляция

Используется в большинстве современных виртуальных машин.

Суть в том, что мы компилируем те программные единицы, которые будут использоваться в ближайшем будущем. То есть, мы должны как то предсказывать это, используя динамическое профилирование: по активности в ближайшем прошлом пытаться угадать активность в ближайшем будущем.

Появляется потребность уметь переходить от скомпилированного кода к интерпретируемому и обратно.

От интерпретируемому кода к скомпилированному::
* Для будущих выполнений - заменить точку входа в программную единицу
* Для текущего выполнения с сохранением его состояния - заменить секцию активации


От скомпилированного кода к интерпретируемому::
Переход с сохранением состояния возможен только в подготовленных во время компиляции точках


image::202/dac.png[]

На рисунке есть профилятор, он взаимодействует с интерпретатором. Профилятор узнает, какие методы нужно компилировать и ставит их в очередь на компиляцию. 

Компилятор достает следующего кандидата из очереди, компилирует и кладет в кэш скомпилированного кода. 

Также есть профилятор скомпилированного кода, который следит за скомпилированными методами. Если некоторый метод перестал быть активным, то он помещает их в очередь на вытеснение. 

Когда кэш заканчивается, то мы вытаскиваем метод из очереди на вытеснение, убираем его из кэша, теперь этот метод снова интерпретируемый.

== Возможности динамической адаптивной компиляции
* Частичная компиляция
** Исходный интерпретируемый код сохраняется
** Поддерживается переход от исполнения скомпилированного кода к интерпретации исходного
** Значит, можно компилировать частично, заменяя отсутствующие фрагменты на переходы к интерпретации
** Можно исключать редко исполняемые фрагменты и сложные для компиляции конструкции
*** Набор компилируемых конструкций можно наращивать по мере необходимости
* Спекулятивная специализация кода
** Специализация — компиляция кода для заданного частного случая (заданных условий)
** Спекулятивная специализация — условия компиляции не доказаны и потому могут в будущем оказаться неверными. Такие условия называются предположениями (assumptions)