= 1.12. Макроподстановка вызовов простых функций в интерпретаторе

Почему раньше не подставили:: Конвертору не был известен код вызываемой функции.

Ограничения:: Интерпретатор не может анализировать код и должен сохранять его длину.

Как реализовать:: Путем сравнения с короткими образцами.

Интерпретатор умеет быстро сравнить тело функции с образцом, и если сравнение успешно, то выполняем замену. В образце написано, на что нужно поменять вызов функции.

Кроме совпадения с образцом нужно проверить аттрибуты функции (например, synchronized), ее метаданные (таблицы try-catch). Также заменяемая инструкция вызова сама могла делать какие-то проверки.

Если совпадение с образцами не найдено, то нужно пометить инструкцию вызова, чтобы в будущем не пытаться сравнивать с образцами.

Подстановка заметна при бросании исключений (нет трассы стека). Можем записать подстановки в _журнал замен_:

* Интерпретатор добавляет запись о замене в таблицу
* При исключении интерпретатор проверит, было ли оно брошено в подставленной функции
* Проверяет, бросило ли его сама инструкция вызова, или оно выброшено в теле функции
* Добавляем секцию в трассу стека

КаРтИнКа:

image::112/image.png[]

Варианты образцов:

image::112/образцы.png[]