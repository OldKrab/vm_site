= 1.11. Оптимизации кода интерпретатором. Quickening. Специализация инструкций по инвариантам состояния

Интерпретатор знает все о запущенной VM:

* С какими опциями запущена
* Знает текущее динамическое состояние программы
** Может оптимизировать для данного выполнения программы
* Не обладает ресурсами для анализа и преобразования программ
** Использует данные, предоставленные конвертером и компилятором

Итеративный интерпретатор может выполнять только локальные оптимизации, *не меняющие длины кода*, потому что изменение длины кода влечет перемещение кода в памяти, коррекцию таблиц и адресов переходов. Рекурсивный интерпретатор может легко менять деревья.

Code Quickening - локальная самомодификация кода для ускорения его будущих выполнений. В частности для VM, замена интерпретатором текущей инструкции или их короткой последовательности на быстрее выполняемую версию
====
Например, подстановка констант прямо в операнды инструкции. 
====

Другие оптимизации:

* Специализация инструкций по инвариантам состояния непосредственных операндов
* Макроподстановки вызовов простых функций (при других ограничениях, чем в конверторе)
* Замена оставшихся после конвертора идиом супер-инструкциями

== Специализация инструкций по инвариантам состояния

Жизненный цикл некоторых языковых объектов состоит из набора состояний с однонаправленными переходами между ними.
====
Например, при ленивой линковке, класс в java может быть один раз найден и загружен, а после чего один раз инициализирован
====

Поэтому мы можем закэшировать неизменяемые свойства объекта в литеральном пуле для ускорения последующих обращений.
====
Для поля - это тип и смещение, для статического поля - тип и адрес. Если класс с полями был загружен, то мы уверены, что типы и смещения его полей не изменятся.
====

При каждом доступе к полю класса `{get|set}field(cp_index)` (cp_index - индекс в литеральном пуле), проверяется, разрешена ли ссылка в литеральном пуле. Если нет, то пытаемся разрешить и запомнить тип и смещение поля. 

Повторные проверки избыточны, ведь тип и смещение не могут измениться.

После успешного разрешения ссылки заменим общую инструкцию специализированной: `<t>{get|set}field(field_offset)`. Которая уже не проверяет, разрешена ли ссылка.

image::111/специализация.png[]





